name: Codex Issue Triage (Optional)

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to triage"
        required: true
        type: string
  issues:
    types: [labeled]

jobs:
  triage:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' && github.event.label.name == 'codex')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write
      pull-requests: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Resolve issue context
        id: issue_ctx
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_ISSUE: ${{ github.event.inputs.issue_number }}
          EVENT_ISSUE: ${{ github.event.issue.number }}
          EVENT_TITLE: ${{ github.event.issue.title }}
          EVENT_BODY: ${{ github.event.issue.body }}
        run: |
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            echo "issue_number=$INPUT_ISSUE" >> "$GITHUB_OUTPUT"
            echo "issue_title=Manual triage request" >> "$GITHUB_OUTPUT"
            echo "issue_body=Triggered via workflow_dispatch for issue #$INPUT_ISSUE" >> "$GITHUB_OUTPUT"
          else
            echo "issue_number=$EVENT_ISSUE" >> "$GITHUB_OUTPUT"
            {
              echo "issue_title<<EOF"
              echo "$EVENT_TITLE"
              echo "EOF"
              echo "issue_body<<EOF"
              echo "$EVENT_BODY"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Run Codex triage
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          safety-strategy: drop-sudo
          codex-args: '["--model","gpt-5-mini"]'
          prompt: |
            You are triaging a GitHub issue for the repository ${{ github.repository }}.

            Issue number: #${{ steps.issue_ctx.outputs.issue_number }}
            Issue title: ${{ steps.issue_ctx.outputs.issue_title }}
            Issue body:
            ---
            ${{ steps.issue_ctx.outputs.issue_body }}
            ---

            Produce a concise triage report with these sections:
            1) Category (bug, enhancement, question, documentation, invalid)
            2) Size estimate (small, medium, large)
            3) Duplicate risk (low/medium/high) with 1-2 keywords to search
            4) Missing information checklist
            5) Suggested maintainer comment to post

            Keep the final output short, actionable, and repository-maintainer friendly.

      - name: Post triage comment
        if: steps.run_codex.outputs.final-message != ''
        uses: actions/github-script@v7
        env:
          TRIAGE_COMMENT: ${{ steps.run_codex.outputs.final-message }}
          ISSUE_NUMBER: ${{ steps.issue_ctx.outputs.issue_number }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number(process.env.ISSUE_NUMBER),
              body: `### Codex Triage (Optional)\n\n${process.env.TRIAGE_COMMENT}`,
            });
