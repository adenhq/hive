name: Issue Triage

on:
  issues:
    types: [opened]

jobs:
  triage:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write
      pull-requests: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Triage and check for duplicates
        uses: anthropics/claude-code-action@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: claude-3-haiku-20240307
          debug: true
          allowed_non_write_users: "*"
          prompt: |
            Analyze this new issue and perform triage tasks.

            Issue: #${{ github.event.issue.number }}
            Repository: ${{ github.repository }}

            ## Your Tasks:

            ### 1. Check for Low-Quality / AI Spam
            Flag the issue as INVALID if it matches these criteria:
            - **Vague/Generic**: Title is "Fix bug" or "Error" without specific context
            - **Hallucinated**: Refers to files or features that don't exist
            - **Template Filler**: Body contains "Insert description here" or unrelated text
            - **Low Effort**: No reproduction steps, no logs, only 1-2 sentences

            If identified as spam/low-quality:
            - Add the "invalid" label
            - Add a comment explaining why
            - Do NOT proceed to other steps

            ### 2. Check for Duplicates
            Search for similar existing issues using mcp__github__search_issues

            If you find a duplicate:
            - Comment: "Found a possible duplicate of #<issue_number>"
            - Do NOT add the "duplicate" label yet

            ### 3. Categorize with Labels
            Apply appropriate labels:
            - bug: Something isn't working
            - enhancement: New feature or request
            - question: Further information is needed
            - documentation: Improvements to docs
            - good first issue: Good for newcomers
            - help wanted: Needs community input
            - backlog: Future consideration

            Be efficient and accurate in your categorization.
