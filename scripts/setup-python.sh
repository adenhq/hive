#!/bin/bash
#
# setup-python.sh - Python Environment Setup for Aden Agent Framework
#
# This script sets up the Python environment with all required packages
# for building and running goal-driven agents.
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Python Version
REQUIRED_PYTHON_VERSION="3.11"

# Python version split into Major and Minor
IFS='.' read -r PYTHON_MAJOR_VERSION PYTHON_MINOR_VERSION <<< "$REQUIRED_PYTHON_VERSION"

# Available python interpreter (follows sequence)
POSSIBLE_PYTHONS=("python3" "python" "py")

# Default python interpreter (initialized)
PYTHON_CMD=()


echo ""
echo "=================================================="
echo "  Aden Agent Framework - Python Setup"
echo "=================================================="
echo ""

# Available Python interpreter
for cmd in "${POSSIBLE_PYTHONS[@]}"; do
    # Check for python interpreter
    if command -v "$cmd" >/dev/null 2>&1; then

        # Specific check for Windows 'py' launcher
        if [ "$cmd" = "py" ]; then
            CURRENT_CMD=(py -3)
        else
            CURRENT_CMD=("$cmd")
        fi

        # Check Python version
        if "${CURRENT_CMD[@]}" -c "import sys; sys.exit(0 if sys.version_info >= ($PYTHON_MAJOR_VERSION, $PYTHON_MINOR_VERSION) else 1)" >/dev/null 2>&1; then
            echo -e "${GREEN}✓${NC} interpreter detected: ${CURRENT_CMD[@]}"
            # Check for pip
            if "${CURRENT_CMD[@]}" -m pip --version >/dev/null 2>&1; then
                PYTHON_CMD=("${CURRENT_CMD[@]}")
                echo -e "${GREEN}✓${NC} pip detected"
                echo ""
                break
            else
                echo -e "${RED}✗${NC} pip not found"
                echo ""
            fi
        else
            echo -e "${RED}✗${NC} ${CURRENT_CMD[@]} not found"
            echo ""
        fi
    fi
done

# Display error message if python not found
if [ "${#PYTHON_CMD[@]}" -eq 0 ]; then
    echo -e "${RED}Error:${NC} No suitable Python interpreter found with pip installed."
    echo ""
    echo "Requirements:"
    echo "  • Python $PYTHON_MAJOR_VERSION.$PYTHON_MINOR_VERSION+"
    echo "  • pip installed"
    echo ""
    echo "Tried the following commands:"
    echo "  ${POSSIBLE_PYTHONS[*]}"
    echo ""
    echo "Please install Python from:"
    echo "  https://www.python.org/downloads/"
    exit 1
fi

# Display Python version
PYTHON_VERSION=$("${PYTHON_CMD[@]}" -c 'import sys; print(f"{sys.version_info.major}.{sys.version_info.minor}")')
echo -e "${BLUE}Detected Python:${NC} $PYTHON_VERSION"
echo -e "${GREEN}✓${NC} Python version check passed"
echo ""

# Check for uv
HAS_UV=false
if command -v uv &> /dev/null; then
    HAS_UV=true
    echo -e "${GREEN}✓${NC} uv detected"
else
    echo -e "${YELLOW}⚠${NC} uv not found. Falling back to standard pip/venv."
    echo "Note: Installation might be slower."
fi
echo ""

# Helper function to get python path in venv (cross-platform)
get_venv_python() {
    local venv_dir="$1"
    if [ -f "$venv_dir/bin/python" ]; then
        echo "$venv_dir/bin/python"
    elif [ -f "$venv_dir/Scripts/python" ]; then
        echo "$venv_dir/Scripts/python"
    elif [ -f "$venv_dir/Scripts/python.exe" ]; then
        echo "$venv_dir/Scripts/python.exe"
    else
        echo ""
    fi
}

# Helper function to create venv
create_venv() {
    local venv_dir="$1"
    if [ "$HAS_UV" = "true" ]; then
        uv venv "$venv_dir"
    else
        "${PYTHON_CMD[@]}" -m venv "$venv_dir"
    fi
}

# Helper function to install package
install_package() {
    local python_exe="$1"
    local args="${@:2}"
    if [ "$HAS_UV" = "true" ]; then
        uv pip install --python "$python_exe" $args
    else
        "$python_exe" -m pip install $args
    fi
}

# Install core framework package
echo "=================================================="
echo "Installing Core Framework Package"
echo "=================================================="
echo ""
cd "$PROJECT_ROOT/core"

# Create venv if it doesn't exist
if [ ! -d ".venv" ]; then
    echo "Creating virtual environment in core/.venv..."
    create_venv ".venv"
    echo -e "${GREEN}✓${NC} Virtual environment created"
else
    echo -e "${GREEN}✓${NC} Virtual environment already exists"
fi
echo ""

if [ -f "pyproject.toml" ]; then
    echo "Installing framework from core/ (editable mode)..."
    CORE_PYTHON=$(get_venv_python ".venv")
    if [ -z "$CORE_PYTHON" ]; then
        echo -e "${RED}Error: Could not find python in core/.venv${NC}"
        exit 1
    fi
    
    if install_package "$CORE_PYTHON" -e .; then
        echo -e "${GREEN}✓${NC} Framework package installed"
    else
        echo -e "${YELLOW}⚠${NC} Framework installation encountered issues (may be OK if already installed)"
    fi
else
    echo -e "${YELLOW}⚠${NC} No pyproject.toml found in core/, skipping framework installation"
fi
echo ""

# Install tools package
echo "=================================================="
echo "Installing Tools Package (aden_tools)"
echo "=================================================="
echo ""
cd "$PROJECT_ROOT/tools"

# Create venv if it doesn't exist
if [ ! -d ".venv" ]; then
    echo "Creating virtual environment in tools/.venv..."
    create_venv ".venv"
    echo -e "${GREEN}✓${NC} Virtual environment created"
else
    echo -e "${GREEN}✓${NC} Virtual environment already exists"
fi
echo ""

if [ -f "pyproject.toml" ]; then
    echo "Installing aden_tools from tools/ (editable mode)..."
    TOOLS_PYTHON=$(get_venv_python ".venv")
    if [ -z "$TOOLS_PYTHON" ]; then
        echo -e "${RED}Error: Could not find python in tools/.venv${NC}"
        exit 1
    fi

    if install_package "$TOOLS_PYTHON" -e .; then
        echo -e "${GREEN}✓${NC} Tools package installed"
    else
        echo -e "${RED}✗${NC} Tools installation failed"
        exit 1
    fi
else
    echo -e "${RED}Error: No pyproject.toml found in tools/${NC}"
    exit 1
fi
echo ""

# Fix openai version compatibility with litellm
echo "=================================================="
echo "Fixing Package Compatibility"
echo "=================================================="
echo ""

TOOLS_PYTHON=$(get_venv_python "$PROJECT_ROOT/tools/.venv")
if [ -z "$TOOLS_PYTHON" ]; then
    echo -e "${RED}Error: Could not find python in tools/.venv${NC}"
    exit 1
fi

# Check openai version in tools venv
OPENAI_VERSION=$($TOOLS_PYTHON -c "import openai; print(openai.__version__)" 2>/dev/null || echo "not_installed")

if [ "$OPENAI_VERSION" = "not_installed" ]; then
    echo "Installing openai package..."
    install_package "$TOOLS_PYTHON" "openai>=1.0.0"
    echo -e "${GREEN}✓${NC} openai package installed"
elif [[ "$OPENAI_VERSION" =~ ^0\. ]]; then
    echo -e "${YELLOW}Found old openai version: $OPENAI_VERSION${NC}"
    echo "Upgrading to openai 1.x+ for litellm compatibility..."
    install_package "$TOOLS_PYTHON" --upgrade "openai>=1.0.0"
    OPENAI_VERSION=$($TOOLS_PYTHON -c "import openai; print(openai.__version__)" 2>/dev/null)
    echo -e "${GREEN}✓${NC} openai upgraded to $OPENAI_VERSION"
else
    echo -e "${GREEN}✓${NC} openai $OPENAI_VERSION is compatible"
fi
echo ""

# Verify installations
echo "=================================================="
echo "Verifying Installation"
echo "=================================================="
echo ""

cd "$PROJECT_ROOT"

# Test framework import using core venv
CORE_PYTHON=$(get_venv_python "$PROJECT_ROOT/core/.venv")
if [ -f "$CORE_PYTHON" ]; then
    if $CORE_PYTHON -c "import framework; print('framework OK')" > /dev/null 2>&1; then
        echo -e "${GREEN}✓${NC} framework package imports successfully"
    else
        echo -e "${RED}✗${NC} framework package import failed"
        echo -e "${YELLOW}  Note: This may be OK if you don't need the framework${NC}"
    fi
else
    echo -e "${RED}✗${NC} core/.venv python not found${NC}"
    exit 1
fi

# Test aden_tools import using tools venv
TOOLS_PYTHON=$(get_venv_python "$PROJECT_ROOT/tools/.venv")
if [ -f "$TOOLS_PYTHON" ]; then
    if $TOOLS_PYTHON -c "import aden_tools; print('aden_tools OK')" > /dev/null 2>&1; then
        echo -e "${GREEN}✓${NC} aden_tools package imports successfully"
    else
        echo -e "${RED}✗${NC} aden_tools package import failed"
        exit 1
    fi
else
    echo -e "${RED}✗${NC} tools/.venv python not found${NC}"
    exit 1
fi

# Test litellm + openai compatibility using tools venv
if $TOOLS_PYTHON -c "import litellm; print('litellm OK')" > /dev/null 2>&1; then
    echo -e "${GREEN}✓${NC} litellm package imports successfully"
else
    echo -e "${YELLOW}⚠${NC} litellm import had issues (may be OK if not using LLM features)"
fi

echo ""

# Print agent commands
echo "=================================================="
echo "  Setup Complete!"
echo "=================================================="
echo ""
echo "Python packages installed:"
echo "  • framework (core agent runtime)"
echo "  • aden_tools (tools and MCP servers)"
echo "  • All dependencies and compatibility fixes applied"
echo ""
echo "To run agents, use:"
echo ""
echo "  ${BLUE}# From project root:${NC}"
echo "  PYTHONPATH=core:exports ${PYTHON_CMD} -m agent_name validate"
echo "  PYTHONPATH=core:exports ${PYTHON_CMD} -m agent_name info"
echo "  PYTHONPATH=core:exports ${PYTHON_CMD} -m agent_name run --input '{...}'"
echo ""
echo "Available commands for your new agent:"
echo "  PYTHONPATH=core:exports ${PYTHON_CMD} -m support_ticket_agent validate"
echo "  PYTHONPATH=core:exports ${PYTHON_CMD} -m support_ticket_agent info"
echo "  PYTHONPATH=core:exports ${PYTHON_CMD} -m support_ticket_agent run --input '{\"ticket_content\":\"...\",\"customer_id\":\"...\",\"ticket_id\":\"...\"}'"
echo ""
echo "To build new agents, use Claude Code skills:"
echo "  • /building-agents - Build a new agent"
echo "  • /testing-agent   - Test an existing agent"
echo ""
echo "Documentation: ${PROJECT_ROOT}/README.md"
echo "Agent Examples: ${PROJECT_ROOT}/exports/"
echo ""
